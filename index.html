<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì½” ì±Œë¦°ì € PRO - ê·¸ë£¹ ë­í‚¹ & í™˜ê²½ ê¸°ì—¬ (AI ì¸ì¦)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* CSS unchanged */
        .pb-safe {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .animate-confetti {
            animation: confetti-burst 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes confetti-burst {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tree-container {
            width: 100px;
            height: 100px;
            position: relative;
            margin: 0 auto;
        }
        .tree-base {
            width: 20px;
            height: 40px;
            background: #8B4513; /* Brown */
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .tree-leaves {
            width: 0;
            height: 0;
            background: #38A169; /* Green */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: all 1s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef } = React;

        // --- Helper: Get Week ID (ISO Week) ---
        const getWeekId = () => {
            const d = new Date();
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() + 4 - (d.getDay()||7));
            const yearStart = new Date(d.getFullYear(),0,1);
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return `${d.getFullYear()}-W${weekNo}`;
        };

        // --- Mock Data: ê°€ìƒ ë­í‚¹ ê²½ìŸìë“¤ ---
        const MOCK_RANKERS = [
            { userId: 'bot1', displayName: 'ì§€êµ¬ì§€í‚´ì´1í˜¸', totalPoints: 1250 },
            { userId: 'bot2', displayName: 'í”Œë¼ìŠ¤í‹±ZERO', totalPoints: 980 },
            { userId: 'bot3', displayName: 'ë¶ê·¹ê³°ì•„ë¯¸ì•ˆí•´', totalPoints: 850 },
            { userId: 'bot4', displayName: 'ì—ì½”ë¼ì´í”„', totalPoints: 620 },
            { userId: 'bot5', displayName: 'ë¶„ë¦¬ìˆ˜ê±°ì™•', totalPoints: 450 },
            { userId: 'bot6', displayName: 'CleanCity', totalPoints: 300 },
        ];

        // --- Icon Mockup (Emoji) ---
        const Icon = (emoji) => ({ className, ...props }) => (
            <span className={className} {...props} style={{ fontSize: '1.25rem', lineHeight: 1 }}>{emoji}</span>
        );
        const Award = Icon('ğŸ†');
        const Zap = Icon('âš¡');
        const Target = Icon('ğŸ¯');
        const Trophy = Icon('ğŸ…');
        const Ranking = Icon('ğŸ“Š');
        const CheckCircle = Icon('âœ…');
        const Flame = Icon('ğŸ”¥');
        const Home = Icon('ğŸ¡');
        const Community = Icon('ğŸ‘¥');
        const Stats = Icon('ğŸŒ');
        const Upload = Icon('ğŸ“¸');
        const Badge = Icon('ğŸ—ï¸');
        const UserIcon = Icon('ğŸ§‘â€ğŸš€');
        const Robot = Icon('ğŸ¤–');

        // --- Data & Constants ---
        const CHALLENGES = {
            DAILY: [
                { id: 1, type: 'PET', title: "íˆ¬ëª… í˜íŠ¸ë³‘ 5ê°œ ë¼ë²¨ ì œê±° í›„ ë°°ì¶œ", points: 20 },
                { id: 2, type: 'BOX', title: "íƒë°° ìƒì í…Œì´í”„ ì œê±° ë° í¼ì¹˜ê¸°", points: 15 },
                { id: 3, type: 'CAN', title: "ìº” ë‚´ìš©ë¬¼ ë¹„ìš°ê³  ê¹¨ë—í•˜ê²Œ í—¹ê¶ˆ ë°°ì¶œ", points: 10 },
            ],
            WEEKLY: [
                { id: 101, type: 'BATTERY', title: "íê±´ì „ì§€/í˜•ê´‘ë“± ì „ìš© ìˆ˜ê±°í•¨ ë°°ì¶œí•˜ê¸°", points: 100 },
                { id: 102, type: 'GLASS', title: "ê¹¨ì§„ ìœ ë¦¬ë¥˜ ì•ˆì „í•˜ê²Œ ë°€ë´‰í•˜ì—¬ ë°°ì¶œ", points: 100 },
                { id: 103, type: 'CLOTHES', title: "ì•ˆ ì…ëŠ” ì˜· ì˜ë¥˜ìˆ˜ê±°í•¨ì— ì •ë¦¬í•˜ê¸°", points: 100 },
            ]
        };
        const BADGES = [
            { threshold: 50, name: "ë¶„ë¦¬ìˆ˜ê±° ì´ˆë³´ íƒˆì¶œ", icon: "ğŸŒ±" },
            { threshold: 200, name: "í”Œë¼ìŠ¤í‹± ë§ˆìŠ¤í„°", icon: "â™»ï¸" },
            { threshold: 500, name: "ì—ì½” ì±Œë¦°ì €", icon: "ğŸŒŸ" },
        ];

        // --- Local Storage Manager (Firebase ëŒ€ì²´) ---
        const DB_KEY = 'eco_challenger_pro_data';
        
        const loadUserData = () => {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) return JSON.parse(stored);
            
            // ì´ˆê¸° ë°ì´í„° ìƒì„±
            const initialData = {
                userId: 'user_' + Math.random().toString(36).substr(2, 9),
                displayName: 'ë‚˜ì˜ ë‹‰ë„¤ì„',
                totalPoints: 0,
                streak: 0,
                lastCompletedDate: null,
                dailyRecord: {},
                weeklyRecord: {},
                challengeLog: [],
                discardStats: { PET: 0, BOX: 0, CAN: 0, PLASTIC: 0, VINYL: 0, ALL: 0 },
                badges: [],
            };
            localStorage.setItem(DB_KEY, JSON.stringify(initialData));
            return initialData;
        };

        const saveUserData = (data) => {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
        };
        
        // --- API Helper Functions ---

        // Convert ArrayBuffer to Base64 string
        const arrayBufferToBase64 = (buffer) => {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        };

        // Fetch with exponential backoff for API calls
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    console.warn(`API call failed with status 429. Retrying in ${Math.pow(2, i)}s...`);
                } catch (error) {
                    console.error('Network error during API call attempt:', error);
                }
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            throw new Error('API call failed after multiple retries.');
        }


        // --- State Management ---
        const initialState = {
            isLoading: true,
            userData: null,
            dailyChallenge: null,
            weeklyChallenge: CHALLENGES.WEEKLY[0],
            globalRanking: [],
            showConfetti: false,
        };

        const reducer = (state, action) => {
            switch (action.type) {
                case 'INIT_SUCCESS':
                    return { ...state, isLoading: false, userData: action.payload.userData, globalRanking: action.payload.ranking };
                case 'UPDATE_USER':
                     // ë­í‚¹ ì—…ë°ì´íŠ¸ ë¡œì§ í¬í•¨
                    const updatedRanking = [...MOCK_RANKERS, action.payload]
                        .sort((a, b) => b.totalPoints - a.totalPoints)
                        .slice(0, 10);
                    return { ...state, userData: action.payload, globalRanking: updatedRanking };
                case 'SET_CHALLENGE':
                    return { ...state, dailyChallenge: action.payload };
                case 'SHOW_CONFETTI':
                    return { ...state, showConfetti: true };
                case 'HIDE_CONFETTI':
                    return { ...state, showConfetti: false };
                default:
                    return state;
            }
        };

        // --- App Component ---
        function App() {
            const [state, dispatch] = useReducer(reducer, initialState);
            const [activeTab, setActiveTab] = useState('home');
             const [validationStatus, setValidationStatus] = useState({
                status: 'idle', // 'idle', 'uploading', 'analyzing', 'success', 'failure'
                message: '',
                challengeId: null
            });

            // 1. ì´ˆê¸°í™” (ë°ì´í„° ë¡œë“œ)
            useEffect(() => {
                // ì‹¤ì œ ì„œë²„ ë¡œë”©ì²˜ëŸ¼ ì‚´ì§ ì§€ì—° íš¨ê³¼
                setTimeout(() => {
                    const userData = loadUserData();
                    
                    // ë±ƒì§€ ì—…ë°ì´íŠ¸ í™•ì¸
                    const currentBadges = userData.badges || [];
                    const earnedBadges = BADGES.filter(b => userData.totalPoints >= b.threshold);
                    
                    if (earnedBadges.length > currentBadges.length) {
                        userData.badges = earnedBadges.map(b => ({ name: b.name, icon: b.icon }));
                        saveUserData(userData);
                    }

                    // ë­í‚¹ ìƒì„± (ë‚´ ì ìˆ˜ í¬í•¨)
                    const ranking = [...MOCK_RANKERS, userData]
                        .sort((a, b) => b.totalPoints - a.totalPoints)
                        .slice(0, 10);

                    // ì±Œë¦°ì§€ ì„¤ì •
                    const todayKey = new Date().toDateString();
                    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì±Œë¦°ì§€ê°€ ì—†ê±°ë‚˜ ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ìƒˆë¡œ ìƒì„±
                    let storedChallenge = localStorage.getItem('eco_daily_challenge');
                    let parsedChallenge = storedChallenge ? JSON.parse(storedChallenge) : null;
                    
                    if (!parsedChallenge || parsedChallenge.date !== todayKey) {
                        const newChallenge = CHALLENGES.DAILY[Math.floor(Math.random() * CHALLENGES.DAILY.length)];
                        parsedChallenge = { date: todayKey, challenge: newChallenge };
                        localStorage.setItem('eco_daily_challenge', JSON.stringify(parsedChallenge));
                    }

                    dispatch({ type: 'SET_CHALLENGE', payload: parsedChallenge.challenge });
                    dispatch({ type: 'INIT_SUCCESS', payload: { userData, ranking } });
                }, 800);
            }, []);

            // 2. ë¯¸ì…˜ ì™„ë£Œ í•¸ë“¤ëŸ¬ (ì ìˆ˜ ë¶€ì—¬ ë° ë°ì´í„° ì—…ë°ì´íŠ¸)
            const handleCompleteChallenge = (challenge, type) => {
                const { userData } = state;
                const todayKey = new Date().toDateString();
                const weekKey = getWeekId();

                // ì¤‘ë³µ ì²´í¬ëŠ” handleValidationì—ì„œ í•œ ë²ˆ ë” í•˜ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ìƒí™©ì— ëŒ€ë¹„
                if (type === 'DAILY' && userData.dailyRecord[todayKey]) return;
                if (type === 'WEEKLY' && userData.weeklyRecord && userData.weeklyRecord[weekKey]) return;

                // ë°ì´í„° ì—…ë°ì´íŠ¸
                const newPoints = userData.totalPoints + challenge.points;
                let newStreak = userData.streak;
                let newDailyRecord = { ...userData.dailyRecord };
                let newWeeklyRecord = { ...(userData.weeklyRecord || {}) };
                let newDiscardStats = { ...userData.discardStats };

                if (type === 'DAILY') {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const yesterdayKey = yesterday.toDateString();

                    if (userData.lastCompletedDate === yesterdayKey) {
                        newStreak += 1;
                    } else if (userData.lastCompletedDate !== todayKey) {
                        newStreak = 1;
                    }
                    newDailyRecord[todayKey] = true;
                }

                if (type === 'WEEKLY') {
                    newWeeklyRecord[weekKey] = true;
                }

                newDiscardStats[challenge.type] = (newDiscardStats[challenge.type] || 0) + 1;
                newDiscardStats['ALL'] = (newDiscardStats['ALL'] || 0) + 1;

                const updatedUser = {
                    ...userData,
                    totalPoints: newPoints,
                    streak: newStreak,
                    lastCompletedDate: todayKey,
                    dailyRecord: newDailyRecord,
                    weeklyRecord: newWeeklyRecord,
                    discardStats: newDiscardStats,
                    challengeLog: [...userData.challengeLog, {
                        date: new Date().toISOString(),
                        challengeId: challenge.id,
                        points: challenge.points,
                        type
                    }]
                };

                // ì €ì¥ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                saveUserData(updatedUser);
                dispatch({ type: 'UPDATE_USER', payload: updatedUser });
                
                // í­ì£½ íš¨ê³¼
                dispatch({ type: 'SHOW_CONFETTI' });
                setTimeout(() => dispatch({ type: 'HIDE_CONFETTI' }), 800);
            };

            // 3. AI ì¸ì¦ í•¸ë“¤ëŸ¬ (ë©”ì¸ ë¡œì§)
            const handleValidation = async (challenge, file) => {
                const { userData } = state;
                const todayKey = new Date().toDateString();
                const weekKey = getWeekId();
                const isCompleted = challenge.type === 'DAILY' ? userData.dailyRecord[todayKey] : userData.weeklyRecord?.[weekKey];

                if (isCompleted) {
                    setValidationStatus({ status: 'failure', message: 'ì´ë¯¸ í•´ë‹¹ ë¯¸ì…˜ì„ ì™„ë£Œí–ˆì–´ìš”!', challengeId: challenge.id });
                    setTimeout(() => setValidationStatus(prev => prev.challengeId === challenge.id ? { status: 'idle', message: '', challengeId: null } : prev), 3000);
                    return;
                }

                setValidationStatus({ status: 'uploading', message: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...', challengeId: challenge.id });

                try {
                    const reader = new FileReader();
                    reader.readAsArrayBuffer(file);

                    reader.onloadend = async () => {
                        const base64ImageData = arrayBufferToBase64(reader.result);
                        
                        setValidationStatus({ status: 'analyzing', message: 'AIê°€ ë¶„ë¦¬ìˆ˜ê±° ìƒíƒœë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', challengeId: challenge.id });

                        const specificPrompt = `
                            Please analyze the image provided. The user claims they completed the recycling task: "${challenge.title}".
                            Based on the image, strictly determine if the primary recycling goal is met according to common South Korean recycling standards.
                            For example, if the title mentions 'remove label from PET bottle', check if the label is clearly removed. If 'flatten cardboard box', check if it's folded flat.
                            
                            Return the result as a single JSON object conforming to the schema. 
                            The feedback must be concise and encouraging (in Korean, less than 20 characters).
                        `;

                        const payload = {
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: specificPrompt },
                                    {
                                        inlineData: {
                                            mimeType: file.type,
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        "isValid": { "type": "BOOLEAN" },
                                        "feedback": { "type": "STRING", "description": "A short feedback message in Korean (less than 20 characters)." }
                                    },
                                    "propertyOrdering": ["isValid", "feedback"]
                                }
                            }
                        };
                        
                        const apiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                        const response = await fetchWithBackoff(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        let validationResult;
                        
                        try {
                            validationResult = JSON.parse(jsonText);
                        } catch (e) {
                             console.error("Failed to parse AI response JSON:", jsonText, e);
                             setValidationStatus({ status: 'failure', message: `AI ì‘ë‹µ ì˜¤ë¥˜! ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`, challengeId: challenge.id });
                             return;
                        }

                        if (validationResult.isValid) {
                            handleCompleteChallenge(challenge, challenge.type);
                            setValidationStatus({ status: 'success', message: 'ì¸ì¦ ì„±ê³µ! í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', challengeId: challenge.id });
                        } else {
                            setValidationStatus({ status: 'failure', message: `[ì¬ì‹œë„ í•„ìš”] ${validationResult.feedback}`, challengeId: challenge.id });
                        }
                    };
                    
                } catch (error) {
                    console.error('AI Validation Process Error:', error);
                    setValidationStatus({ status: 'failure', message: `API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`, challengeId: challenge.id });
                } finally {
                    // Automatically clear status after a delay
                    setTimeout(() => setValidationStatus(prev => prev.challengeId === challenge.id ? { status: 'idle', message: '', challengeId: null } : prev), 5000);
                }
            };
            

            const handleNewDailyChallenge = () => {
                const newChallenge = CHALLENGES.DAILY[Math.floor(Math.random() * CHALLENGES.DAILY.length)];
                const todayKey = new Date().toDateString();
                localStorage.setItem('eco_daily_challenge', JSON.stringify({ date: todayKey, challenge: newChallenge }));
                dispatch({ type: 'SET_CHALLENGE', payload: newChallenge });
            };

            if (state.isLoading) {
                 return (
                    <div className="min-h-screen flex flex-col justify-center items-center bg-gray-50 text-gray-500">
                        <Zap className="animate-spin text-4xl mb-4 text-emerald-500" />
                        <p className="font-bold text-lg">ì—ì½” ì±Œë¦°ì € ë¡œë”© ì¤‘...</p>
                    </div>
                 );
            }

            const currentLevel = Math.floor(state.userData.totalPoints / 100) + 1;
            
            const currentView = {
                'home': <HomeView 
                            state={state} 
                            handleCompleteChallenge={handleCompleteChallenge} 
                            handleNewDailyChallenge={handleNewDailyChallenge}
                            handleValidation={handleValidation}
                            validationStatus={validationStatus}
                        />,
                'ranking': <RankingView state={state} />,
                'stats': <StatsView state={state} />,
                'community': <CommunityView />,
            }[activeTab];

            return (
                <div className="bg-gray-50 min-h-screen text-gray-800 font-sans selection:bg-emerald-200">
                    <Header level={currentLevel} totalPoints={state.userData.totalPoints} displayName={state.userData.displayName} />
                    <main className="max-w-md mx-auto h-[calc(100vh-8rem)] overflow-y-auto">
                        {currentView}
                    </main>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        }

        // --- Sub Components ---
        const Header = ({ level, totalPoints, displayName }) => (
            <header className="bg-gradient-to-r from-emerald-500 to-green-600 text-white p-4 shadow-xl sticky top-0 z-40">
                <div className="flex justify-between items-center max-w-md mx-auto">
                    <div className="flex flex-col items-start">
                        <div className="text-xs opacity-80 flex items-center">
                            <UserIcon className="w-4 h-4 mr-1 text-yellow-300" />
                            {displayName}
                        </div>
                        <h1 className="text-xl font-bold">{totalPoints} P</h1>
                    </div>
                    <div className="text-right flex flex-col items-end">
                        <div className="text-xs opacity-80">LEVEL {level}</div>
                        <div className="font-bold text-3xl">{level >= 5 ? 'ğŸ‘‘' : level >= 3 ? 'ğŸŒŸ' : 'ğŸŒ±'}</div>
                    </div>
                </div>
            </header>
        );

        const HomeView = ({ state, handleCompleteChallenge, handleNewDailyChallenge, handleValidation, validationStatus }) => {
            const { userData, dailyChallenge, weeklyChallenge, showConfetti } = state;
            const todayKey = new Date().toDateString();
            const weekKey = getWeekId();
            const isDailyCompleted = userData.dailyRecord[todayKey];
            const isWeeklyCompleted = userData.weeklyRecord ? userData.weeklyRecord[weekKey] : false;
            const currentLevel = Math.floor(userData.totalPoints / 100) + 1;

            return (
                <div className="p-4 space-y-4 pb-20">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
                            <Flame className={`w-8 h-8 mx-auto mb-1 ${userData.streak > 0 ? 'text-red-500' : 'text-gray-400'}`} />
                            <h2 className="text-2xl font-extrabold text-gray-800">{userData.streak}ì¼ ì—°ì†</h2>
                            <p className="text-xs text-gray-500">ğŸ”¥ ì—°ì† ì„±ê³µ</p>
                        </div>
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                             <h3 className="text-base font-bold text-gray-800 flex items-center mb-1">
                                <Trophy className="w-4 h-4 mr-1 text-yellow-500" />
                                ë ˆë²¨
                            </h3>
                            <div className="flex justify-between items-center">
                                <span className="text-2xl font-bold text-gray-800">LV.{currentLevel}</span>
                                <span className="text-xs text-gray-500">+{100 - (userData.totalPoints % 100)} P</span>
                            </div>
                             <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div className="bg-yellow-500 h-2 rounded-full transition-all duration-500" style={{ width: `${(userData.totalPoints % 100)}%` }}></div>
                            </div>
                        </div>
                    </div>

                    <ChallengeCard 
                        challenge={dailyChallenge}
                        type="DAILY"
                        isCompleted={isDailyCompleted}
                        handleValidation={handleValidation}
                        handleNewChallenge={handleNewDailyChallenge}
                        showConfetti={showConfetti}
                        validationStatus={validationStatus}
                    />

                    <ChallengeCard 
                        challenge={weeklyChallenge}
                        type="WEEKLY"
                        isCompleted={isWeeklyCompleted}
                        handleValidation={handleValidation}
                        showConfetti={false}
                        validationStatus={validationStatus}
                    />
                </div>
            );
        };

        const ChallengeCard = ({ challenge, type, isCompleted, handleValidation, handleNewChallenge, showConfetti, validationStatus }) => {
            const fileInputRef = useRef(null);
            
            // í˜„ì¬ ì±Œë¦°ì§€ IDì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ ìƒíƒœ í‘œì‹œ
            const currentValidation = validationStatus.challengeId === challenge.id ? validationStatus : { status: 'idle' };
            const isAnalyzing = currentValidation.status === 'analyzing' || currentValidation.status === 'uploading';

            const handleClickUpload = () => {
                if (!isCompleted && !isAnalyzing) {
                    fileInputRef.current.click();
                }
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    handleValidation(challenge, file);
                }
                // Reset file input value to allow the same file to be selected again
                event.target.value = null;
            };
            
            // Determine button state and content
            let buttonContent;
            let buttonClass = "w-full py-4 rounded-xl font-bold shadow-lg transition active:scale-95 flex items-center justify-center relative z-30";
            
            if (isCompleted) {
                buttonContent = (
                     <>
                        <CheckCircle className="w-6 h-6 mr-2" /> ë¯¸ì…˜ ì™„ë£Œ!
                    </>
                );
                buttonClass += " bg-green-500 text-white cursor-default";
            } else if (currentValidation.status === 'uploading') {
                 buttonContent = (
                    <>
                        <Zap className="animate-spin w-6 h-6 mr-2" /> ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...
                    </>
                );
                buttonClass += " bg-blue-400 text-white cursor-not-allowed";
            } else if (currentValidation.status === 'analyzing') {
                 buttonContent = (
                    <>
                        <Robot className="animate-pulse w-6 h-6 mr-2" /> AI ë¶„ì„ ì¤‘...
                    </>
                );
                buttonClass += " bg-indigo-500 text-white cursor-not-allowed";
            } else {
                buttonContent = (
                    <>
                        <Upload className="w-6 h-6 mr-2" /> ë¶„ë¦¬ìˆ˜ê±° ì¸ì¦ ì‚¬ì§„ ì—…ë¡œë“œ
                    </>
                );
                buttonClass += " bg-emerald-600 text-white hover:bg-emerald-700";
            }
            
            // Feedback message display
            let feedbackDisplay = null;
            if (currentValidation.status === 'success') {
                feedbackDisplay = <div className="mt-3 text-sm font-semibold text-green-700 bg-green-100 p-3 rounded-xl border border-green-300 shadow-inner">{currentValidation.message}</div>;
            } else if (currentValidation.status === 'failure') {
                feedbackDisplay = <div className="mt-3 text-sm font-semibold text-red-700 bg-red-100 p-3 rounded-xl border border-red-300 shadow-inner">{currentValidation.message}</div>;
            }


            return (
                <div className="bg-white border-2 border-blue-200 rounded-3xl p-6 shadow-lg relative overflow-hidden">
                    {showConfetti && (
                        <div className="absolute inset-0 z-20 overflow-hidden pointer-events-none">
                            {[...Array(10)].map((_, i) => (
                                <div key={i} className="absolute w-2 h-2 rounded-full animate-confetti" 
                                    style={{ left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, backgroundColor: ['#f00', '#0f0', '#00f', '#ff0', '#0ff'][i % 5], animationDelay: `${i * 0.1}s` }}
                                />
                            ))}
                        </div>
                    )}
                    <h3 className={`text-lg font-bold flex items-center mb-2 ${type === 'DAILY' ? 'text-blue-800' : 'text-purple-800'}`}>
                        <Target className="w-5 h-5 mr-2 text-blue-500" />
                        {type === 'DAILY' ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ (${challenge.points} P)` : `ì£¼ê°„ íŠ¹ë³„ ë¯¸ì…˜ (${challenge.points} P)`}
                    </h3>
                    <p className="text-xl font-extrabold text-gray-800 leading-snug mb-5">{challenge.title}</p>
                    
                    <button 
                        onClick={handleClickUpload} 
                        className={buttonClass}
                        disabled={isCompleted || isAnalyzing}
                    >
                        {buttonContent}
                    </button>
                    
                    {/* Hidden file input for image selection */}
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={handleFileChange} 
                        accept="image/*" 
                        style={{ display: 'none' }} 
                    />
                    
                    {feedbackDisplay}

                    {(type === 'DAILY' && !isCompleted && !isAnalyzing) && (
                        <button onClick={handleNewChallenge} className="w-full mt-2 text-sm text-gray-500 hover:text-gray-700 transition">ë‹¤ë¥¸ ë¯¸ì…˜ìœ¼ë¡œ ë³€ê²½</button>
                     )}
                </div>
            );
        };

        const RankingView = ({ state }) => {
            const { globalRanking, userData } = state;
            return (
                <div className="p-4 space-y-4 pb-20">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                        <Ranking className="w-6 h-6 mr-2 text-blue-500" /> 
                        ì±Œë¦°ì € ë­í‚¹ (Top 10)
                    </h2>
                    <p className="text-sm text-gray-500">ì—´ì‹¬íˆ í™œë™í•˜ëŠ” ì±Œë¦°ì €ë“¤ê³¼ì˜ ìˆœìœ„ì…ë‹ˆë‹¤.</p>
                    <div className="bg-white rounded-xl shadow-md divide-y divide-gray-100">
                        {globalRanking.map((ranker, index) => (
                            <div key={ranker.userId} className={`flex justify-between items-center p-4 ${ranker.userId === userData.userId ? 'bg-yellow-50 border-l-4 border-yellow-500 font-bold' : ''}`}>
                                <div className="flex items-center space-x-3">
                                    <span className={`text-lg font-extrabold w-6 text-center ${index < 3 ? 'text-red-500' : 'text-gray-500'}`}>
                                        {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                    </span>
                                    <span className="text-gray-800">{ranker.displayName} {ranker.userId === userData.userId && '(ë‚˜)'}</span>
                                </div>
                                <span className="text-green-600 font-bold">{ranker.totalPoints} P</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StatsView = ({ state }) => {
            const { userData } = state;
            const totalRecycledCount = userData.discardStats.ALL || 0;
            const treeGrowthPercentage = Math.min(100, (totalRecycledCount * 5));
            const treeLevel = Math.floor(treeGrowthPercentage / 20);
            const mapTypeToLabel = (type) => ({ PET: 'í˜íŠ¸ë³‘', BOX: 'ì¢…ì´ìƒì', CAN: 'ìº”', PLASTIC: 'í”Œë¼ìŠ¤í‹±', VINYL: 'ë¹„ë‹', BATTERY: 'íê±´ì „ì§€', GLASS: 'ìœ ë¦¬ë¥˜', CLOTHES: 'ì˜ë¥˜' })[type] || type;
            const stats = Object.entries(userData.discardStats).filter(([key]) => key !== 'ALL').map(([type, count]) => ({ type, count })).sort((a, b) => b.count - a.count);
            const mostDiscarded = stats.length > 0 ? stats[0].type : 'N/A';
            const mostDiscardedCount = stats.length > 0 ? stats[0].count : 0;

            return (
                <div className="p-4 space-y-6 pb-20">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><Stats className="w-6 h-6 mr-2 text-green-500" /> ë‚˜ì˜ í™˜ê²½ ê¸°ì—¬ë„</h2>
                    <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100 text-center">
                        <h3 className="text-xl font-bold text-gray-700 mb-4">ë‚˜ë§Œì˜ ì—ì½” ë‚˜ë¬´ (Level {treeLevel})</h3>
                        <div className="tree-container my-6">
                            <div className="tree-base"></div>
                            <div className="tree-leaves" style={{ width: `${30 + treeGrowthPercentage * 0.7}px`, height: `${30 + treeGrowthPercentage * 0.7}px`, background: treeGrowthPercentage > 0 ? '#38A169' : '#ccc', transform: `translate(-50%, -50%) scale(${treeGrowthPercentage / 100})`, top: `${50 - (treeGrowthPercentage / 4)}%` }}></div>
                        </div>
                        <p className="text-lg font-semibold text-green-600 mt-4">ì´ {totalRecycledCount}íšŒ ë¶„ë¦¬ë°°ì¶œ ì„±ê³µ</p>
                    </div>
                    <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100">
                        <h3 className="text-xl font-bold text-gray-700 flex items-center mb-3"><Badge className="w-5 h-5 mr-2 text-yellow-500" /> íšë“í•œ ë±ƒì§€ ({userData.badges.length})</h3>
                        <div className="flex flex-wrap gap-2">
                            {userData.badges.map(b => (<div key={b.name} className="flex items-center bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1.5 rounded-full shadow-sm">{b.icon} {b.name}</div>))}
                            {userData.badges.length === 0 && <p className="text-sm text-gray-400">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>}
                        </div>
                    </div>
                     <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100">
                        <h3 className="text-xl font-bold text-gray-700 flex items-center mb-4"><i className="fas fa-chart-bar mr-2"></i> ë‚˜ì˜ ë¶„ë¦¬ìˆ˜ê±° í†µê³„</h3>
                        <p className="text-lg font-semibold mb-3">ê°€ì¥ ë§ì´ ë²„ë¦° ìœ í˜•: <span className="text-blue-600">{mapTypeToLabel(mostDiscarded)} ({mostDiscardedCount}íšŒ)</span></p>
                        <div className="space-y-2">
                            {stats.slice(0, 5).map(({ type, count }) => (
                                <div key={type} className="flex items-center">
                                    <span className="w-20 text-sm text-gray-600">{mapTypeToLabel(type)}</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-3"><div className="bg-blue-400 h-3 rounded-full" style={{ width: `${Math.max(10, (count / mostDiscardedCount) * 100)}%` }}></div></div>
                                    <span className="ml-2 text-sm text-gray-600">{count}íšŒ</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CommunityView = () => (
            <div className="p-8 text-center pt-20">
                <Community className="text-6xl text-gray-300 mb-4" />
                <h2 className="text-xl font-bold text-gray-700">ì»¤ë®¤ë‹ˆí‹°</h2>
                <p className="text-sm text-gray-500 mt-2">ì´ ê¸°ëŠ¥ì€ ì„œë²„ ì—°ë™ì´ í•„ìš”í•˜ì—¬<br/>í˜„ì¬ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            </div>
        );

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'home', icon: Home, label: 'ë¯¸ì…˜' },
                { id: 'ranking', icon: Ranking, label: 'ë­í‚¹' },
                { id: 'stats', icon: Stats, label: 'ê¸°ì—¬ë„' },
                { id: 'community', icon: Community, label: 'ì»¤ë®¤ë‹ˆí‹°' },
            ];
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-40">
                    <div className="flex justify-around items-center max-w-md mx-auto h-16">
                        {tabs.map((tab) => {
                            const Icon = tab.icon;
                            const isActive = tab.id === activeTab;
                            return (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition ${isActive ? 'text-emerald-600' : 'text-gray-400 hover:text-gray-600'}`}>
                                    <Icon className={`w-6 h-6 transition-transform ${isActive ? 'scale-110' : ''}`} />
                                    <span className="text-xs font-medium">{tab.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </nav>
            );
        };

        window.onload = () => {
             const container = document.getElementById('root');
             if (container) {
                const root = ReactDOM.createRoot(container);
                root.render(<App />);
             } else {
                 console.error("Root container not found.");
             }
        };
    </script>
</body>
</html>
