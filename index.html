<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì½” ì±Œë¦°ì € PRO - ê·¸ë£¹ ë­í‚¹ & í™˜ê²½ ê¸°ì—¬</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Must be V11+) -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, limit, orderBy,
            setLogLevel 
        };
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (typeof crypto.randomUUID === 'undefined') {
            crypto.randomUUID = () => 'anon-' + Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
        }
    </script>

    <style>
        .pb-safe {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .animate-confetti {
            animation: confetti-burst 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes confetti-burst {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tree-container {
            width: 100px;
            height: 100px;
            position: relative;
            margin: 0 auto;
        }
        .tree-base {
            width: 20px;
            height: 40px;
            background: #8B4513; /* Brown */
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        .tree-leaves {
            width: 0;
            height: 0;
            background: #38A169; /* Green */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: all 1s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer } = React;

        // --- Helper: Get Week ID (ISO Week) ---
        // ì£¼ì°¨ë³„ ê³ ìœ  IDë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (ì˜ˆ: "2025-W12")
        const getWeekId = () => {
            const d = new Date();
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() + 4 - (d.getDay()||7));
            const yearStart = new Date(d.getFullYear(),0,1);
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return `${d.getFullYear()}-W${weekNo}`;
        };

        // --- Icon Mockup (Emoji) ---
        const Icon = (emoji) => ({ className, ...props }) => (
            <span className={className} {...props} style={{ fontSize: '1.25rem', lineHeight: 1 }}>{emoji}</span>
        );
        const Award = Icon('ğŸ†');
        const Zap = Icon('âš¡');
        const Target = Icon('ğŸ¯');
        const Trophy = Icon('ğŸ…');
        const Ranking = Icon('ğŸ“Š');
        const CheckCircle = Icon('âœ…');
        const Flame = Icon('ğŸ”¥');
        const Home = Icon('ğŸ¡');
        const Community = Icon('ğŸ‘¥');
        const Stats = Icon('ğŸŒ');
        const Upload = Icon('ğŸ“¸');
        const Badge = Icon('ğŸ—ï¸');
        const UserIcon = Icon('ğŸ§‘â€ğŸš€');


        // --- Data & Constants ---
        const CHALLENGES = {
            DAILY: [
                { id: 1, type: 'PET', title: "íˆ¬ëª… í˜íŠ¸ë³‘ 5ê°œ ë¼ë²¨ ì œê±° í›„ ë°°ì¶œ", points: 20 },
                { id: 2, type: 'BOX', title: "íƒë°° ìƒì í…Œì´í”„ ì œê±° ë° í¼ì¹˜ê¸°", points: 15 },
                { id: 3, type: 'CAN', title: "ìº” ë‚´ìš©ë¬¼ ë¹„ìš°ê³  ê¹¨ë—í•˜ê²Œ í—¹ê¶ˆ ë°°ì¶œ", points: 10 },
            ],
            // ì£¼ê°„ ë¯¸ì…˜ ë‚´ìš©ì„ 'ì‚¬ì§„ ì¸ì¦'ì´ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
            WEEKLY: [
                { id: 101, type: 'BATTERY', title: "íê±´ì „ì§€/í˜•ê´‘ë“± ì „ìš© ìˆ˜ê±°í•¨ ë°°ì¶œí•˜ê¸°", points: 100 },
                { id: 102, type: 'GLASS', title: "ê¹¨ì§„ ìœ ë¦¬ë¥˜ ì•ˆì „í•˜ê²Œ ë°€ë´‰í•˜ì—¬ ë°°ì¶œ", points: 100 },
                { id: 103, type: 'CLOTHES', title: "ì•ˆ ì…ëŠ” ì˜· ì˜ë¥˜ìˆ˜ê±°í•¨ì— ì •ë¦¬í•˜ê¸°", points: 100 },
            ]
        };
        const BADGES = [
            { threshold: 50, name: "ë¶„ë¦¬ìˆ˜ê±° ì´ˆë³´ íƒˆì¶œ", icon: "ğŸŒ±" },
            { threshold: 200, name: "í”Œë¼ìŠ¤í‹± ë§ˆìŠ¤í„°", icon: "â™»ï¸" },
            { threshold: 500, name: "ì—ì½” ì±Œë¦°ì €", icon: "ğŸŒŸ" },
        ];


        // --- Firestore State Management ---

        const initialState = {
            isAuthReady: false,
            userId: null,
            db: null,
            auth: null,
            // User Data
            userData: {
                userId: null,
                displayName: 'Loading...',
                totalPoints: 0,
                streak: 0,
                lastCompletedDate: null,
                dailyRecord: {},
                weeklyRecord: {}, // ì£¼ê°„ ê¸°ë¡ ì¶”ê°€
                challengeLog: [],
                discardStats: { PET: 0, BOX: 0, CAN: 0, PLASTIC: 0, VINYL: 0, ALL: 0 },
                badges: [],
            },
            // UI State
            dailyChallenge: null,
            weeklyChallenge: CHALLENGES.WEEKLY[0],
            globalRanking: [],
            error: null,
            showConfetti: false,
        };

        const reducer = (state, action) => {
            switch (action.type) {
                case 'SET_INIT_SUCCESS':
                    return { ...state, isAuthReady: true, db: action.payload.db, auth: action.payload.auth, userId: action.payload.userId };
                case 'SET_ERROR':
                    console.error("Firestore Error:", action.payload);
                    return { ...state, error: action.payload };
                case 'SET_USER_DATA':
                    const updatedBadges = BADGES
                        .filter(b => action.payload.totalPoints >= b.threshold)
                        .map(b => ({ name: b.name, icon: b.icon }));

                    // weeklyRecordê°€ ì—†ëŠ” êµ¬ë²„ì „ ë°ì´í„°ë¥¼ ìœ„í•œ ë°©ì–´ ì½”ë“œ
                    const safeUserData = {
                        ...action.payload,
                        weeklyRecord: action.payload.weeklyRecord || {},
                        badges: updatedBadges
                    };

                    return { ...state, userData: safeUserData };
                case 'SET_RANKING':
                    return { ...state, globalRanking: action.payload };
                case 'SET_CHALLENGES':
                    return { ...state, dailyChallenge: action.payload.daily, weeklyChallenge: action.payload.weekly };
                case 'SHOW_CONFETTI':
                    return { ...state, showConfetti: true };
                case 'HIDE_CONFETTI':
                    return { ...state, showConfetti: false };
                default:
                    return state;
            }
        };

        const getUserProfileRef = (db, appId, userId) => {
            return firebase.doc(db, `artifacts/${appId}/users/${userId}/data`, 'user_profile');
        };

        const getGlobalRankingRef = (db, appId, userId) => {
            return firebase.doc(db, `artifacts/${appId}/public/data/global_ranking`, userId);
        };
        
        const getGlobalRankingCollection = (db, appId) => {
            return firebase.collection(db, `artifacts/${appId}/public/data`, 'global_ranking');
        };

        // --- Core Application Logic (App Component) ---

        function App() {
            const [state, dispatch] = useReducer(reducer, initialState);
            const [activeTab, setActiveTab] = useState('home');

            useEffect(() => {
                const initFirebase = async () => {
                    if (!window.firebase || !window.firebaseConfig.apiKey) {
                        dispatch({ type: 'SET_ERROR', payload: "Firebase configuration is missing." });
                        return;
                    }
                    
                    try {
                        const app = window.firebase.initializeApp(window.firebaseConfig);
                        const auth = window.firebase.getAuth(app);
                        const db = window.firebase.getFirestore(app);
                        
                        if (window.firebase.setLogLevel) {
                            window.firebase.setLogLevel('debug');
                        }

                        await new Promise(resolve => {
                            const unsubscribe = window.firebase.onAuthStateChanged(auth, async (user) => {
                                if (user) {
                                    resolve(user.uid);
                                } else {
                                    try {
                                        if (window.initialAuthToken) {
                                            const credential = await window.firebase.signInWithCustomToken(auth, window.initialAuthToken);
                                            resolve(credential.user.uid);
                                        } else {
                                            const credential = await window.firebase.signInAnonymously(auth);
                                            resolve(credential.user.uid);
                                        }
                                    } catch (e) {
                                        console.error("Authentication failed:", e);
                                        const anonId = crypto.randomUUID();
                                        resolve(anonId);
                                    }
                                }
                                if (unsubscribe) unsubscribe();
                            });
                        });
                        
                        const userId = auth.currentUser?.uid || crypto.randomUUID();
                        
                        dispatch({ type: 'SET_INIT_SUCCESS', payload: { db, auth, userId } });

                        const profileRef = getUserProfileRef(db, window.appId, userId);
                        const profileSnap = await window.firebase.getDoc(profileRef);

                        if (!profileSnap.exists()) {
                            const newProfile = {
                                ...initialState.userData,
                                userId: userId,
                                displayName: `EcoUser_${userId.substring(0, 4).toUpperCase()}`,
                            };
                            await window.firebase.setDoc(profileRef, newProfile);
                            await window.firebase.setDoc(getGlobalRankingRef(db, window.appId, userId), { 
                                userId: userId, 
                                displayName: newProfile.displayName, 
                                totalPoints: 0, 
                                lastUpdated: new Date()
                            });
                        }
                    } catch (e) {
                        dispatch({ type: 'SET_ERROR', payload: e.message });
                    }
                };

                initFirebase();
            }, []);
            
            useEffect(() => {
                if (!state.isAuthReady || !state.userId || !state.db) return;

                const profileRef = getUserProfileRef(state.db, window.appId, state.userId);
                const unsubscribeProfile = window.firebase.onSnapshot(profileRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        dispatch({ type: 'SET_USER_DATA', payload: data });
                    }
                }, (error) => {
                    console.error("User Profile Snapshot Error:", error);
                });

                const rankingQuery = window.firebase.query(
                    getGlobalRankingCollection(state.db, window.appId),
                    window.firebase.limit(50)
                );
                const unsubscribeRanking = window.firebase.onSnapshot(rankingQuery, (snapshot) => {
                    let rankingData = snapshot.docs.map(doc => doc.data());
                    rankingData.sort((a, b) => b.totalPoints - a.totalPoints);
                    dispatch({ type: 'SET_RANKING', payload: rankingData.slice(0, 10) }); 
                }, (error) => {
                    console.error("Ranking Snapshot Error:", error);
                });
                
                const todayKey = new Date().toDateString();
                const storedChallenge = state.dailyChallenge || CHALLENGES.DAILY[Math.floor(Math.random() * CHALLENGES.DAILY.length)];
                
                if (!state.dailyChallenge) {
                    dispatch({ type: 'SET_CHALLENGES', payload: { daily: storedChallenge, weekly: CHALLENGES.WEEKLY[0] } });
                }

                return () => {
                    unsubscribeProfile();
                    unsubscribeRanking();
                };
            }, [state.isAuthReady, state.userId, state.db]);

            // --- Handlers ---

            const handleCompleteChallenge = async (challenge, type) => {
                if (!state.userId || !state.db || !state.userData) return;
                
                const todayKey = new Date().toDateString();
                const weekKey = getWeekId(); // ì´ë²ˆ ì£¼ ID ê°€ì ¸ì˜¤ê¸°

                // 1. ì¤‘ë³µ ì™„ë£Œ ì²´í¬ (Daily & Weekly ëª¨ë‘ ì ìš©)
                if (type === 'DAILY' && state.userData.dailyRecord[todayKey]) {
                    console.log("Daily challenge already completed today.");
                    return;
                }
                if (type === 'WEEKLY' && state.userData.weeklyRecord && state.userData.weeklyRecord[weekKey]) {
                    console.log("Weekly challenge already completed this week.");
                    return;
                }
                
                // 2. Update Data
                const newPoints = state.userData.totalPoints + challenge.points;
                let newStreak = state.userData.streak;
                let newDailyRecord = { ...state.userData.dailyRecord };
                let newWeeklyRecord = { ...(state.userData.weeklyRecord || {}) }; // ì£¼ê°„ ê¸°ë¡ ë³µì‚¬
                let newDiscardStats = { ...state.userData.discardStats };

                if (type === 'DAILY') {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const yesterdayKey = yesterday.toDateString();
                    
                    if (state.userData.lastCompletedDate === yesterdayKey) {
                        newStreak = state.userData.streak + 1;
                    } else if (state.userData.lastCompletedDate !== todayKey) {
                        newStreak = 1;
                    }
                    newDailyRecord[todayKey] = true;
                }

                if (type === 'WEEKLY') {
                    newWeeklyRecord[weekKey] = true; // ì£¼ê°„ ì™„ë£Œ ê¸°ë¡ ì €ì¥
                }
                
                newDiscardStats[challenge.type] = (newDiscardStats[challenge.type] || 0) + 1;
                newDiscardStats['ALL'] = (newDiscardStats['ALL'] || 0) + 1;

                const profileRef = getUserProfileRef(state.db, window.appId, state.userId);
                const rankingRef = getGlobalRankingRef(state.db, window.appId, state.userId);

                try {
                    // Update User Profile
                    await window.firebase.setDoc(profileRef, {
                        totalPoints: newPoints,
                        streak: newStreak,
                        lastCompletedDate: todayKey,
                        dailyRecord: newDailyRecord,
                        weeklyRecord: newWeeklyRecord, // ì£¼ê°„ ê¸°ë¡ ì €ì¥
                        discardStats: newDiscardStats,
                        challengeLog: [...state.userData.challengeLog, { 
                            date: new Date().toISOString(), 
                            challengeId: challenge.id, 
                            points: challenge.points,
                            type: type
                        }]
                    }, { merge: true });

                    // Update Public Ranking
                    await window.firebase.setDoc(rankingRef, {
                        totalPoints: newPoints,
                        displayName: state.userData.displayName,
                        lastUpdated: new Date()
                    }, { merge: true });

                    dispatch({ type: 'SHOW_CONFETTI' });
                    setTimeout(() => dispatch({ type: 'HIDE_CONFETTI' }), 800);
                    
                } catch (e) {
                    dispatch({ type: 'SET_ERROR', payload: "ë¯¸ì…˜ ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message });
                }
            };
            
            const handleNewDailyChallenge = () => {
                const newChallenge = CHALLENGES.DAILY[Math.floor(Math.random() * CHALLENGES.DAILY.length)];
                dispatch({ type: 'SET_CHALLENGES', payload: { daily: newChallenge, weekly: state.weeklyChallenge } });
            };


            const currentLevel = Math.floor(state.userData.totalPoints / 100) + 1;

            if (state.error) {
                return <div className="p-8 text-center text-red-600 bg-red-100 min-h-screen">ì˜¤ë¥˜ ë°œìƒ: {state.error}</div>;
            }

            if (!state.isAuthReady || !state.dailyChallenge) {
                 return <div className="p-8 text-center min-h-screen flex flex-col justify-center items-center text-gray-500">
                    <Zap className="animate-spin text-3xl mb-4" />
                    <p className="font-bold">ì—ì½” ì±Œë¦°ì € ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</p>
                    <p className="text-sm mt-1">ì‚¬ìš©ì ì¸ì¦ ë° ë°ì´í„° ì—°ê²° ì¤‘ì…ë‹ˆë‹¤.</p>
                </div>;
            }
            
            const currentView = {
                'home': <HomeView 
                            state={state} 
                            dispatch={dispatch} 
                            handleCompleteChallenge={handleCompleteChallenge} 
                            handleNewDailyChallenge={handleNewDailyChallenge}
                        />,
                'ranking': <RankingView state={state} />,
                'stats': <StatsView state={state} />,
                'community': <CommunityView />,
            }[activeTab];

            return (
                <div className="bg-gray-50 min-h-screen text-gray-800 font-sans selection:bg-emerald-200">
                    <Header 
                        level={currentLevel} 
                        totalPoints={state.userData.totalPoints} 
                        displayName={state.userData.displayName}
                        userId={state.userId}
                    />
                    
                    <main className="max-w-md mx-auto h-[calc(100vh-8rem)] overflow-y-auto">
                        {currentView}
                    </main>

                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        }

        const Header = ({ level, totalPoints, displayName, userId }) => (
            <header className="bg-gradient-to-r from-emerald-500 to-green-600 text-white p-4 shadow-xl sticky top-0 z-40">
                <div className="flex justify-between items-center max-w-md mx-auto">
                    <div className="flex flex-col items-start">
                        <div className="text-xs opacity-80 flex items-center">
                            <UserIcon className="w-4 h-4 mr-1 text-yellow-300" />
                            {displayName}
                        </div>
                        <h1 className="text-xl font-bold">{totalPoints} P</h1>
                        <p className="text-xs opacity-70">ID: {userId.substring(0, 10)}...</p>
                    </div>
                    <div className="text-right flex flex-col items-end">
                        <div className="text-xs opacity-80">LEVEL {level}</div>
                        <div className="font-bold text-3xl">
                            {currentLevelToIcon(level)}
                        </div>
                    </div>
                </div>
            </header>
        );

        const currentLevelToIcon = (level) => {
            if (level >= 5) return 'ğŸ‘‘';
            if (level >= 3) return 'ğŸŒŸ';
            return 'ğŸŒ±';
        };
        
        const HomeView = ({ state, handleCompleteChallenge, handleNewDailyChallenge }) => {
            const { userData, dailyChallenge, weeklyChallenge, showConfetti } = state;
            const todayKey = new Date().toDateString();
            const weekKey = getWeekId();
            
            const isDailyCompleted = userData.dailyRecord[todayKey];
            const isWeeklyCompleted = userData.weeklyRecord ? userData.weeklyRecord[weekKey] : false;
            
            const currentLevel = Math.floor(userData.totalPoints / 100) + 1;

            return (
                <div className="p-4 space-y-4 pb-20">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
                            <Flame className={`w-8 h-8 mx-auto mb-1 ${userData.streak > 0 ? 'text-red-500' : 'text-gray-400'}`} />
                            <h2 className="text-2xl font-extrabold text-gray-800">{userData.streak}ì¼ ì—°ì†</h2>
                            <p className="text-xs text-gray-500">ğŸ”¥ ì—°ì† ì„±ê³µ</p>
                        </div>
                        <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                             <h3 className="text-base font-bold text-gray-800 flex items-center mb-1">
                                <Trophy className="w-4 h-4 mr-1 text-yellow-500" />
                                ì±Œë¦°ì € ë ˆë²¨
                            </h3>
                            <div className="flex justify-between items-center">
                                <span className="text-2xl font-bold text-gray-800">LV.{currentLevel}</span>
                                <span className="text-xs text-gray-500">+{100 - (userData.totalPoints % 100)} P</span>
                            </div>
                             <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div 
                                    className="bg-yellow-500 h-2 rounded-full transition-all duration-500" 
                                    style={{ width: `${(userData.totalPoints % 100)}%` }}
                                ></div>
                            </div>
                        </div>
                    </div>

                    <ChallengeCard 
                        challenge={dailyChallenge}
                        type="DAILY"
                        isCompleted={isDailyCompleted}
                        handleComplete={() => handleCompleteChallenge(dailyChallenge, 'DAILY')}
                        handleNewChallenge={handleNewDailyChallenge}
                        showConfetti={showConfetti}
                    />

                    <ChallengeCard 
                        challenge={weeklyChallenge}
                        type="WEEKLY"
                        isCompleted={isWeeklyCompleted}
                        handleComplete={() => handleCompleteChallenge(weeklyChallenge, 'WEEKLY')}
                        showConfetti={false}
                    />
                </div>
            );
        };
        
        const ChallengeCard = ({ challenge, type, isCompleted, handleComplete, handleNewChallenge, showConfetti }) => (
            <div className="bg-white border-2 border-blue-200 rounded-3xl p-6 shadow-lg relative overflow-hidden">
                {showConfetti && (
                    <div className="absolute inset-0 z-20 overflow-hidden pointer-events-none">
                        {[...Array(10)].map((_, i) => (
                            <div key={i} className="absolute w-2 h-2 rounded-full animate-confetti" 
                                style={{ 
                                    left: `${Math.random() * 100}%`, 
                                    top: `${Math.random() * 100}%`, 
                                    backgroundColor: ['#f00', '#0f0', '#00f', '#ff0', '#0ff'][i % 5],
                                    animationDelay: `${i * 0.1}s`,
                                }}
                            />
                        ))}
                    </div>
                )}
                <h3 className={`text-lg font-bold flex items-center mb-2 ${type === 'DAILY' ? 'text-blue-800' : 'text-purple-800'}`}>
                    <Target className="w-5 h-5 mr-2 text-blue-500" />
                    {type === 'DAILY' ? `ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ (${challenge.points} P)` : `ì£¼ê°„ íŠ¹ë³„ ë¯¸ì…˜ (${challenge.points} P)`}
                </h3>
                <p className="text-xl font-extrabold text-gray-800 leading-snug mb-5">
                    {challenge.title}
                </p>
                
                {!isCompleted ? (
                    <button
                        onClick={handleComplete}
                        className="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition active:scale-95 flex items-center justify-center relative z-30"
                    >
                        <Upload className="w-6 h-6 mr-2" />
                        ë¶„ë¦¬ìˆ˜ê±° ì¸ì¦ ì‚¬ì§„ ì—…ë¡œë“œ (ë¯¸ì…˜ ì™„ë£Œ)
                    </button>
                ) : (
                    <div className="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-center flex items-center justify-center">
                        <CheckCircle className="w-6 h-6 mr-2" />
                        {type === 'DAILY' ? 'ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì™„ë£Œ!' : 'ì´ë²ˆ ì£¼ ë¯¸ì…˜ ì™„ë£Œ!'}
                    </div>
                )}
                {(type === 'DAILY' && !isCompleted) && (
                    <button 
                        onClick={handleNewChallenge} 
                        className="w-full mt-2 text-sm text-gray-500 hover:text-gray-700 transition"
                    >
                        ë‹¤ë¥¸ ë¯¸ì…˜ìœ¼ë¡œ ë³€ê²½
                    </button>
                 )}
            </div>
        );


        const RankingView = ({ state }) => {
            const { globalRanking, userId } = state;
            
            return (
                <div className="p-4 space-y-4 pb-20">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                        <Ranking className="w-6 h-6 mr-2 text-blue-500" /> 
                        ì±Œë¦°ì € ë­í‚¹ (Top 10)
                    </h2>
                    <p className="text-sm text-gray-500">ì¹œêµ¬ì™€ ë™ë„¤ ì‚¬ëŒë“¤ì˜ ì‹¤ì‹œê°„ ë­í‚¹ì…ë‹ˆë‹¤. (ì´ í¬ì¸íŠ¸ ê¸°ì¤€)</p>
                    
                    <div className="bg-white rounded-xl shadow-md divide-y divide-gray-100">
                        {globalRanking.length === 0 && <p className="p-4 text-center text-gray-400">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>}
                        {globalRanking.map((ranker, index) => (
                            <div key={ranker.userId} className={`flex justify-between items-center p-4 ${ranker.userId === userId ? 'bg-yellow-50 border-l-4 border-yellow-500 font-bold' : ''}`}>
                                <div className="flex items-center space-x-3">
                                    <span className={`text-lg font-extrabold w-6 text-center ${index < 3 ? 'text-red-500' : 'text-gray-500'}`}>
                                        {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                    </span>
                                    <span className="text-gray-800">{ranker.displayName}</span>
                                </div>
                                <span className="text-green-600 font-bold">{ranker.totalPoints} P</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const StatsView = ({ state }) => {
            const { userData } = state;
            const totalRecycledCount = userData.discardStats.ALL || 0;
            const treeGrowthPercentage = Math.min(100, (totalRecycledCount * 5));
            const treeLevel = Math.floor(treeGrowthPercentage / 20);

            const stats = Object.entries(userData.discardStats)
                .filter(([key]) => key !== 'ALL')
                .map(([type, count]) => ({ type, count }))
                .sort((a, b) => b.count - a.count);

            const mostDiscarded = stats.length > 0 ? stats[0].type : 'N/A';
            const mostDiscardedCount = stats.length > 0 ? stats[0].count : 0;
            
            const mapTypeToLabel = (type) => ({ PET: 'í˜íŠ¸ë³‘', BOX: 'ì¢…ì´ìƒì', CAN: 'ìº”', PLASTIC: 'í”Œë¼ìŠ¤í‹±', VINYL: 'ë¹„ë‹' })[type] || type;

            return (
                <div className="p-4 space-y-6 pb-20">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                        <Stats className="w-6 h-6 mr-2 text-green-500" /> 
                        ë‚˜ì˜ í™˜ê²½ ê¸°ì—¬ë„
                    </h2>

                    <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100 text-center">
                        <h3 className="text-xl font-bold text-gray-700 mb-4">
                            ë‚˜ë§Œì˜ ì—ì½” ë‚˜ë¬´ í‚¤ìš°ê¸° (Level {treeLevel})
                        </h3>
                        <div className="tree-container my-6">
                            <div className="tree-base"></div>
                            <div 
                                className="tree-leaves" 
                                style={{ 
                                    width: `${30 + treeGrowthPercentage * 0.7}px`, 
                                    height: `${30 + treeGrowthPercentage * 0.7}px`, 
                                    background: treeGrowthPercentage > 0 ? '#38A169' : '#ccc',
                                    transform: `translate(-50%, -50%) scale(${treeGrowthPercentage / 100})`,
                                    top: `${50 - (treeGrowthPercentage / 4)}%`
                                }}
                            ></div>
                        </div>
                        <p className="text-lg font-semibold text-green-600 mt-4">
                            ì´ {totalRecycledCount}íšŒ ë¶„ë¦¬ë°°ì¶œ ì„±ê³µ
                        </p>
                        <p className="text-sm text-gray-500">
                            ì´ëŠ” ë‚˜ë¬´ ì•½ **{treeLevel}ê·¸ë£¨**ë¥¼ í‚¤ìš´ íš¨ê³¼ì™€ ê°™ìŠµë‹ˆë‹¤!
                        </p>
                    </div>

                    <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100">
                        <h3 className="text-xl font-bold text-gray-700 flex items-center mb-3">
                            <Badge className="w-5 h-5 mr-2 text-yellow-500" />
                            íšë“í•œ ë±ƒì§€ ({userData.badges.length})
                        </h3>
                        <div className="flex flex-wrap gap-2">
                            {userData.badges.map(b => (
                                <div key={b.name} className="flex items-center bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1.5 rounded-full shadow-sm">
                                    {b.icon} {b.name}
                                </div>
                            ))}
                            {userData.badges.length === 0 && <p className="text-sm text-gray-400">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤. í¬ì¸íŠ¸ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!</p>}
                        </div>
                    </div>

                    <div className="bg-white rounded-xl p-6 shadow-md border border-gray-100">
                        <h3 className="text-xl font-bold text-gray-700 flex items-center mb-4">
                            <i className="fas fa-chart-bar mr-2"></i>
                            ë‚˜ì˜ ë¶„ë¦¬ìˆ˜ê±° í†µê³„
                        </h3>
                        <p className="text-lg font-semibold mb-3">
                            ê°€ì¥ ë§ì´ ë²„ë¦° ìœ í˜•: <span className="text-blue-600">{mapTypeToLabel(mostDiscarded)} ({mostDiscardedCount}íšŒ)</span>
                        </p>
                        <div className="space-y-2">
                            {stats.slice(0, 5).map(({ type, count }) => (
                                <div key={type} className="flex items-center">
                                    <span className="w-20 text-sm text-gray-600">{mapTypeToLabel(type)}</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-3">
                                        <div 
                                            className="bg-blue-400 h-3 rounded-full" 
                                            style={{ width: `${Math.max(10, (count / mostDiscardedCount) * 100)}%` }}
                                        ></div>
                                    </div>
                                    <span className="ml-2 text-sm text-gray-600">{count}íšŒ</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        const CommunityView = () => (
            <div className="p-8 text-center pt-20">
                <Community className="text-6xl text-gray-300 mb-4" />
                <h2 className="text-xl font-bold text-gray-700">ì»¤ë®¤ë‹ˆí‹° (ì¤€ë¹„ ì¤‘)</h2>
                <p className="text-sm text-gray-500 mt-2">
                    ì¹œêµ¬ë“¤ê³¼ ê·¸ë£¹ì„ ë§Œë“¤ê±°ë‚˜, ë™ë„¤ë³„ ì±Œë¦°ì§€ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤!
                </p>
            </div>
        );


        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'home', icon: Home, label: 'ë¯¸ì…˜' },
                { id: 'ranking', icon: Ranking, label: 'ë­í‚¹' },
                { id: 'stats', icon: Stats, label: 'ê¸°ì—¬ë„' },
                { id: 'community', icon: Community, label: 'ì»¤ë®¤ë‹ˆí‹°' },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-40">
                    <div className="flex justify-around items-center max-w-md mx-auto h-16">
                        {tabs.map((tab) => {
                            const Icon = tab.icon;
                            const isActive = tab.id === activeTab;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition ${
                                        isActive ? 'text-emerald-600' : 'text-gray-400 hover:text-gray-600'
                                    }`}
                                >
                                    <Icon className={`w-6 h-6 transition-transform ${isActive ? 'scale-110' : ''}`} />
                                    <span className="text-xs font-medium">{tab.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </nav>
            );
        };

        window.onload = () => {
             const container = document.getElementById('root');
             if (container) {
                const root = ReactDOM.createRoot(container);
                root.render(<App />);
             } else {
                 console.error("Root container not found.");
             }
        };

    </script>
</body>
</html>
